<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <title>Write a named scope to fetch the data sorted by distance using Geokit</title>
  <meta name="author" content="Abhilash M A" />

  <!-- syntax highlighting CSS -->
  <link rel="stylesheet" href="/css/syntax-highlight.css" type="text/css" />
  
  <!-- Homepage CSS -->
  <link rel="stylesheet" href="/css/screen-projection.css" type="text/css" media="screen, projection" />
  
  <link rel="stylesheet" href="/css/application.css" type="text/css" />

  <link rel="icon" type="image/ico" href="/ruby-icon.ico" />
   <!--[if lte IE 8]>
   <script type="text/javascript">
     // Create elements here allows IE8 to style them when it sees the real thing.
     document.createElement('article');
     document.createElement('aside');
     document.createElement('footer');
     document.createElement('header');
     document.createElement('hgroup');
     document.createElement('menu');
     document.createElement('nav');
     document.createElement('section');
   </script>
   <![endif]-->
   <script type="text/javascript">var
     switchTo5x=true;
   </script>
   <script type="text/javascript" src="http://w.sharethis.com/button/buttons.js">
   </script>
   <script type="text/javascript">stLight.options({publisher:'21abf337-23b8-4364-b61a-87c7c2e65d83'});</script>
</head>
<body>

<div class="site">
  <div class="posts left-section">
    <div class="title">
      <h1><a href="/">Abhi On Rails</a></h1>
      <div class="title-desc">Ruby On Rails - What I learned recently</div>
    </div>
    
    

<article>
<header>
  <time datetime="2011-11-02" pubdate="pubdate" class="post-date">
    Nov 02, 2011
  </time>
  <h1><a href="/ruby/gem/named/scope/Geokit/order/by/distance/rails/sort/by/distance/distance_sql/chain/named/scope/2011/11/02/Write-a-named-scope-to-fetch-the-data-sorted-by-distance-using-Geokit/">Write a named scope to fetch the data sorted by distance using Geokit</a></h1>
</header>

<div dir="ltr" style="text-align: left;" trbidi="on">Recently I had to work on a feature "As a User ISBAT see the Business sorted by distance". We are using Geokit gem for manipulating the location. And we have the models 'Business' has many 'Location's.<br /><br />I had to fetch the businesses in the order of the distance of the locations from the origin. The origin is the point which we will pass to the method. Since this method should be part of a chained named scope, I had to implement this as a named scope.<br /><br />After done some searching I found a useful link from <a href="http://pivotallabs.com/users/nick/blog/articles/284-hasfinder-it-s-now-easier-than-ever-to-create-complex-re-usable-sql-queries">pivotallabs</a>. At the end there is one comment from Keith:<br /><pre style="background-attachment: initial; background-clip: initial; background-color: white; background-image: initial; background-origin: initial; line-height: 18px; margin-bottom: 0.9em; margin-top: 0.9em; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;"><code style="font: normal normal normal 12px/normal 'bitstream vera sans mono', monaco, 'lucida console', 'courier new', courier, serif; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><span class="Apple-style-span" style="color: #990000; font-family: 'Courier New', Courier, monospace; font-size: small;"><b>named_scope :within, lambda{|o, d| <br />      origin = o<br />      distance_sql = self.distance_sql(origin)<br />      within = d<br />      {:select =&gt; "*, #{distance_sql} as distance",<br />       :conditions =&gt; "#{distance_sql} &lt;= #{within}",&nbsp;<br />       :order =&gt; 'distance asc'}}</b></span></code></pre>This code helped me to create a named scope which will fetch the businesses in the order of the distance.<br /><br />The test also passed for this named scope. But in the controller, where I am using this named scope along with other named scopes i,e, chained named scope, the named scope was not working as expected. It was throwing MySql Error with message "distance is undefined".<br /><br />After done with some searching I found the <a href="http://railsforum.com/viewtopic.php?id=26769">link</a>&nbsp;which explains that in chain named_scopes only conditions will get added, and selects will get ignored.<br /><br />Then I tried by changing the 'distance' variable with the <span class="Apple-style-span" style="color: #990000; font-family: 'Courier New', Courier, monospace;">distance_sql</span><span class="Apple-style-span" style="font-family: inherit;">&nbsp;as the order value. And it worked:</span><br /><pre style="background-attachment: initial; background-clip: initial; background-color: white; background-image: initial; background-origin: initial; line-height: 18px; margin-bottom: 0.9em; margin-top: 0.9em; padding-bottom: 8px; padding-left: 8px; padding-right: 8px; padding-top: 8px;"><code style="font: normal normal normal 12px/normal 'bitstream vera sans mono', monaco, 'lucida console', 'courier new', courier, serif; margin-bottom: 0px; margin-left: 0px; margin-right: 0px; margin-top: 0px;"><span class="Apple-style-span" style="color: #990000; font-family: 'Courier New', Courier, monospace; font-size: small;"><b>named_scope :by_location, lambda{|origin, within| <br />      distance_sql = Location.distance_sql(origin)<br />      {:select =&gt; "*",<br />       :conditions =&gt; "#{distance_sql} &lt;= #{within}",&nbsp;<br />       :order =&gt; '#{distance_sql}', :joins =&gt; :locations</b></span></code><b style="color: #990000; font-family: 'Courier New', Courier, monospace; line-height: normal;">}}</b></pre><br /></div><div class="blogger-post-footer"><img width='1' height='1' src='https://blogger.googleusercontent.com/tracker/7585462888260154580-4428960323059044950?l=abhionrails.blogspot.com' alt='' /></div>

<div class="share-this">
<span  class='st_email_hcount' displayText='Email' st_url="http://abhidsm.github.com/ruby/gem/named/scope/Geokit/order/by/distance/rails/sort/by/distance/distance_sql/chain/named/scope/2011/11/02/Write-a-named-scope-to-fetch-the-data-sorted-by-distance-using-Geokit/" st_title="Write a named scope to fetch the data sorted by distance using Geokit"></span>
<span  class='st_twitter_hcount' displayText='Tweet' st_url="http://abhidsm.github.com/ruby/gem/named/scope/Geokit/order/by/distance/rails/sort/by/distance/distance_sql/chain/named/scope/2011/11/02/Write-a-named-scope-to-fetch-the-data-sorted-by-distance-using-Geokit/" st_title="Write a named scope to fetch the data sorted by distance using Geokit #abhidsm"></span>
<span  class='st_facebook_hcount' displayText='Facebook' st_url="http://abhidsm.github.com/ruby/gem/named/scope/Geokit/order/by/distance/rails/sort/by/distance/distance_sql/chain/named/scope/2011/11/02/Write-a-named-scope-to-fetch-the-data-sorted-by-distance-using-Geokit/" st_title="Write a named scope to fetch the data sorted by distance using Geokit"></span>
<span  class='st_fblike_hcount' st_url="http://abhidsm.github.com/\/ruby/gem/named/scope/Geokit/order/by/distance/rails/sort/by/distance/distance_sql/chain/named/scope/2011/11/02/Write-a-named-scope-to-fetch-the-data-sorted-by-distance-using-Geokit/" st_title="Write a named scope to fetch the data sorted by distance using Geokit"></span>
<span  class='st_plusone_hcount' st_url="http://abhidsm.github.com/ruby/gem/named/scope/Geokit/order/by/distance/rails/sort/by/distance/distance_sql/chain/named/scope/2011/11/02/Write-a-named-scope-to-fetch-the-data-sorted-by-distance-using-Geokit/" st_title="Write a named scope to fetch the data sorted by distance using Geokit"></span>
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'abhidsm'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

<div class="post-nav">
  
  <div class="post-newer">
    <a class="small" href="/ruby/marked/for/destruction/auto/save/association/auto/save/ruby/on/rails/rails/marked_for_destruction/active/record/base/2011/11/04/marked-for-destruction/">marked for destruction &rarr;</a>
  </div>
  
  
  <div class="post-older">
    <a class="small" href="/ruby/gem/issue/callback/rails/after_save/acts_as_taggable_on/gem/2011/10/07/acts_as_taggable_on-gem-have-issue-with-after_save-callback/">&larr; acts_as_taggable_on gem hav...</a>
  </div>
  
  <hr />
</div>

</article>




    
    <div class="footer">
      <div class="contact">
        <p>
          Abhilash M A<br />
        abhidsm@gmail.com
        </p>
      </div>
      <div class="contact">
        <p>
          <a href="http://github.com/abhidsm/">github.com/abhidsm</a><br />
        <a href="http://twitter.com/abhidsm/">twitter.com/abhidsm</a><br />
        </p>
      </div>
      <div class="copy-right">
        Copyright Â© 2011 Abhilash M A. Powered by <a target="_new"
        href="http://github.com/mojombo/jekyll">Jekyll</a>
        and <a target="_new" href="http://github.com">Github</a>.
      </div>
    </div>
  </div>
  <div class="right-section">
    <div class="home margin-top-10"><a href="/">Home</a></div>
    <div class="archive margin-top-10"><a href="/archive">Archive</a></div>
    <div class="about margin-top-10"><a target="_new" href="http://about.me/abhidsm">About</a></div>
    <div class="working-with-rails-badge margin-top-10">
      <a href="http://www.workingwithrails.com/recommendation/new/person/20833-abhilash-m-a"><img alt="Recommend Me" src="http://workingwithrails.com/images/tools/compact-med.jpg" /></a>
    </div>
<!--    <div class="work margin-top-10"> 
      <ul>Working At
        <li><a target="_new" href="http://www.multunus.com">Multunus Software Pvt. Ltd.</a></li>
      </ul>
    </div> -->
    <div class="one-more-blog margin-top-10"> 
      <ul>I have one more blog
        <li><a target="_new" href="http://abhidsm.com">Abhi's Experiments</a></li>
      </ul>
    </div>
    <div class="spare-time-apps margin-top-10"> 
      <ul>My Spare-Time Apps
        <li><a target="_new" href="http://flamesgame.appspot.com">Flames Game</a></li>
        <li><a target="_new" href="http://justchat.nodester.com">Just Chat</a></li>
      </ul>
    </div>
    <div class="friends margin-top-10"> 
      <ul>Blogs of my Friends
        <li><a target="_new" href="http://foobarnbaz.com/">Sreejith K</a></li>
        <li><a target="_new" href="http://manuknkra.wordpress.com/">Manu K Mohan</a></li>
      </ul>
    </div>
    <div class="following margin-top-10"> 
      <ul>I am following the following:
        <li><a target="_new" href="http://news.ycombinator.com/">Hacker News</a></li>
        <li><a target="_new" href="http://techcrunch.com/">Tech Crunch</a></li>
        <li><a target="_new" href="http://www.techmeme.com/">Tech Meme</a></li>
      </ul>
    </div>
  </div>
</div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'abhidsm'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>
